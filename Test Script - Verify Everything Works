#!/usr/bin/env python3
"""
Test script to verify all components work before submission
Run this to catch any issues early!
"""

import sys
import os
from pathlib import Path

print("üß™ Infrastructure Investment Intelligence - System Test")
print("=" * 60)

# ============================================================
# TEST 1: Check Prerequisites
# ============================================================

print("\nüìã TEST 1: Checking prerequisites...")

errors = []

# Check Python version
python_version = sys.version_info
if python_version < (3, 11):
    errors.append(f"Python 3.11+ required, found {python_version.major}.{python_version.minor}")
else:
    print(f"‚úÖ Python version: {python_version.major}.{python_version.minor}.{python_version.micro}")

# Check required files
required_files = [
    "infrastructure_tools.py",
    "infrastructure_investment_orchestrator.yaml",
    "coverage_gap_analyst.yaml",
    "market_readiness_evaluator.yaml",
    "requirements.txt",
    "README.md",
    "sadc.db"
]

for file in required_files:
    if not Path(file).exists():
        errors.append(f"Missing file: {file}")
    else:
        print(f"‚úÖ Found: {file}")

# ============================================================
# TEST 2: Check Dependencies
# ============================================================

print("\nüì¶ TEST 2: Checking Python dependencies...")

required_packages = [
    "duckdb",
    "pandas",
    "numpy",
    "streamlit",
    "plotly"
]

for package in required_packages:
    try:
        __import__(package)
        print(f"‚úÖ {package} installed")
    except ImportError:
        errors.append(f"Missing package: {package}")
        print(f"‚ùå {package} NOT installed")

# ============================================================
# TEST 3: Verify Database
# ============================================================

print("\nüóÑÔ∏è  TEST 3: Verifying database...")

try:
    import duckdb
    
    if not Path("sadc.db").exists():
        errors.append("Database file sadc.db not found")
    else:
        con = duckdb.connect("sadc.db", read_only=True)
        
        # Check tables
        tables = con.execute("SHOW TABLES").fetchdf()
        required_tables = ["settlements", "towers", "demographics_long"]
        
        for table in required_tables:
            if table in tables['name'].values:
                count = con.execute(f"SELECT COUNT(*) FROM {table}").fetchone()[0]
                print(f"‚úÖ Table '{table}' exists with {count:,} rows")
            else:
                errors.append(f"Missing table: {table}")
        
        con.close()
        
except Exception as e:
    errors.append(f"Database error: {str(e)}")

# ============================================================
# TEST 4: Test Core Tools
# ============================================================

print("\nüîß TEST 4: Testing core tools...")

try:
    sys.path.insert(0, '.')
    from infrastructure_tools import (
        find_coverage_gaps,
        get_country_metrics,
        calculate_readiness_index,
        estimate_deployment_cost
    )
    
    # Test 1: Coverage gaps
    print("\n  Testing find_coverage_gaps...")
    result = find_coverage_gaps("Zimbabwe", 10)
    if 'country' in result:
        print(f"  ‚úÖ Found {result.get('underserved_settlements', 0)} underserved settlements")
    else:
        errors.append(f"Coverage gap tool error: {result.get('error', 'Unknown')}")
    
    # Test 2: Country metrics
    print("\n  Testing get_country_metrics...")
    result = get_country_metrics("South Africa")
    if 'data' in result and len(result['data']) > 0:
        print(f"  ‚úÖ Retrieved {result['metrics_count']} metrics")
    else:
        errors.append("Country metrics tool returned no data")
    
    # Test 3: Readiness index
    print("\n  Testing calculate_readiness_index...")
    result = calculate_readiness_index()
    if 'rankings' in result and len(result['rankings']) > 0:
        print(f"  ‚úÖ Calculated readiness for {result['countries_analyzed']} countries")
        top_country = result['rankings'][0]
        print(f"  Top: {top_country['country']} ({top_country['readiness_index']:.2f})")
    else:
        errors.append("Readiness index calculation failed")
    
    # Test 4: Cost estimation
    print("\n  Testing estimate_deployment_cost...")
    result = estimate_deployment_cost(10, "Zambia")
    if 'cost_breakdown_usd' in result:
        total = result['cost_breakdown_usd']['total']
        print(f"  ‚úÖ Estimated cost: ${total:,}")
    else:
        errors.append("Cost estimation failed")
    
except Exception as e:
    errors.append(f"Tool test error: {str(e)}")
    import traceback
    traceback.print_exc()

# ============================================================
# TEST 5: Check Agent YAML Files
# ============================================================

print("\nüìù TEST 5: Validating agent definitions...")

try:
    import yaml
    
    agent_files = [
        "infrastructure_investment_orchestrator.yaml",
        "coverage_gap_analyst.yaml",
        "market_readiness_evaluator.yaml"
    ]
    
    for agent_file in agent_files:
        with open(agent_file, 'r') as f:
            agent_def = yaml.safe_load(f)
            
            # Check required fields
            if 'name' in agent_def and 'description' in agent_def:
                print(f"‚úÖ {agent_file} valid")
            else:
                errors.append(f"Invalid agent definition: {agent_file}")
                
except Exception as e:
    errors.append(f"Agent validation error: {str(e)}")

# ============================================================
# TEST 6: Streamlit App Check
# ============================================================

print("\nüé® TEST 6: Checking Streamlit app...")

if Path("streamlit_demo_app.py").exists():
    print("‚úÖ Streamlit app file exists")
    
    # Try to parse it
    try:
        with open("streamlit_demo_app.py", 'r') as f:
            content = f.read()
            
        if 'st.set_page_config' in content:
            print("‚úÖ Streamlit configuration found")
        else:
            errors.append("Streamlit app may be incomplete")
            
    except Exception as e:
        errors.append(f"Error reading Streamlit app: {str(e)}")
else:
    errors.append("streamlit_demo_app.py not found")

# ============================================================
# FINAL REPORT
# ============================================================

print("\n" + "=" * 60)
print("üìä TEST RESULTS")
print("=" * 60)

if not errors:
    print("\n‚úÖ ‚úÖ ‚úÖ  ALL TESTS PASSED! ‚úÖ ‚úÖ ‚úÖ")
    print("\nYour system is ready for deployment!")
    print("\nNext steps:")
    print("1. Deploy agents to watsonx Orchestrate:")
    print("   orchestrate agents import --file infrastructure_investment_orchestrator.yaml")
    print("\n2. Start Streamlit app:")
    print("   streamlit run streamlit_demo_app.py")
    print("\n3. Create demo video")
    print("\n4. Submit to hackathon!")
    
else:
    print(f"\n‚ùå FOUND {len(errors)} ERROR(S):\n")
    for i, error in enumerate(errors, 1):
        print(f"{i}. {error}")
    
    print("\nüîß Fix these issues before proceeding!")
    sys.exit(1)

print("\n" + "=" * 60)

# ============================================================
# BONUS: Generate Sample Queries
# ============================================================

print("\nüí° SAMPLE QUERIES FOR DEMO:\n")

sample_queries = [
    "What are the top 5 SADC countries for infrastructure investment?",
    "Find underserved settlements in Zimbabwe within 15km of towers",
    "Show me internet adoption trends in Mozambique since 2010",
    "Estimate deployment costs for 25 towers in Zambia with full infrastructure",
    "Compare market readiness between South Africa, Botswana, and Namibia",
    "Where should we expand telecommunications in Southern Africa?",
    "What's the ROI potential for rural deployment in Malawi?",
    "Analyse coverage gaps in Tanzania and recommend priority locations"
]

for i, query in enumerate(sample_queries, 1):
    print(f"{i}. \"{query}\"")

print("\n" + "=" * 60)
print("üöÄ Ready to win this hackathon! Good luck!")
print("=" * 60)
