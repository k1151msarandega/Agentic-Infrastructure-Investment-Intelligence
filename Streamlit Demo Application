# ============================================================
# PAGE CONFIG
# ============================================================

st.set_page_config(
    page_title="Infrastructure Investment Intelligence",
    page_icon="üì°",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        font-weight: bold;
        color: #0f62fe;
        margin-bottom: 0.5rem;
    }
    .sub-header {
        font-size: 1.2rem;
        color: #525252;
        margin-bottom: 2rem;
    }
    .metric-card {
        background-color: #f4f4f4;
        padding: 1rem;
        border-radius: 0.5rem;
        border-left: 4px solid #0f62fe;
    }
    .success-box {
        background-color: #d4f1d4;
        padding: 1rem;
        border-radius: 0.5rem;
        border-left: 4px solid #24a148;
    }
    .warning-box {
        background-color: #fff3cd;
        padding: 1rem;
        border-radius: 0.5rem;
        border-left: 4px solid #ffc107;
    }
</style>
""", unsafe_allow_html=True)

# ============================================================
# SIDEBAR
# ============================================================

st.sidebar.image("https://www.ibm.com/brand/experience-guides/developer/b1db1ae501d522a1a4b49613fe07c9f1/01_8-bar-positive.svg", width=150)
st.sidebar.title("ü§ñ Agent Controls")

SADC_COUNTRIES = [
    "Angola", "Botswana", "Comoros", "DR Congo", "Eswatini",
    "Lesotho", "Madagascar", "Malawi", "Mauritius", "Mozambique",
    "Namibia", "Seychelles", "South Africa", "Tanzania",
    "Zambia", "Zimbabwe"
]

analysis_type = st.sidebar.selectbox(
    "Select Analysis",
    ["üéØ Quick Assessment", "üìä Regional Comparison", "üó∫Ô∏è Coverage Gap Analysis", "üí∞ Cost Estimation"]
)

selected_country = st.sidebar.selectbox("Select Country", SADC_COUNTRIES)

st.sidebar.markdown("---")
st.sidebar.markdown("### About")
st.sidebar.info(
    "**Infrastructure Investment Intelligence** uses AI agents to help telecom operators "
    "and investors identify optimal deployment locations across Africa. "
    "\n\nPowered by **IBM watsonx Orchestrate**."
)

# ============================================================
# MAIN CONTENT
# ============================================================

st.markdown('<p class="main-header">üì° Infrastructure Investment Intelligence</p>', unsafe_allow_html=True)
st.markdown('<p class="sub-header">AI-Powered Deployment Planning for SADC Region</p>', unsafe_allow_html=True)

# ============================================================
# ANALYSIS 1: QUICK ASSESSMENT
# ============================================================

if analysis_type == "üéØ Quick Assessment":
    st.header(f"Quick Assessment: {selected_country}")
    
    with st.spinner("ü§ñ Agent analyzing market readiness..."):
        # Get readiness index
        readiness_data = calculate_readiness_index(selected_country)
        
        if readiness_data['countries_analyzed'] > 0:
            country_data = readiness_data['rankings'][0]
            
            # Display key metrics
            col1, col2, col3, col4 = st.columns(4)
            
            with col1:
                readiness_score = country_data['readiness_index']
                st.metric(
                    "Readiness Index",
                    f"{readiness_score:.2f}",
                    delta="High" if readiness_score > 0.6 else "Medium" if readiness_score > 0.3 else "Low"
                )
            
            with col2:
                st.metric(
                    "Internet Adoption",
                    f"{country_data.get('internet_pct', 0):.1f}%"
                )
            
            with col3:
                st.metric(
                    "Electricity Access",
                    f"{country_data.get('elec_pct', 0):.1f}%"
                )
            
            with col4:
                st.metric(
                    "GDP per Capita",
                    f"${country_data.get('gdp_ppp', 0):,.0f}"
                )
            
            # Readiness gauge
            fig = go.Figure(go.Indicator(
                mode="gauge+number+delta",
                value=readiness_score * 100,
                domain={'x': [0, 1], 'y': [0, 1]},
                title={'text': "Market Readiness Score"},
                delta={'reference': 50},
                gauge={
                    'axis': {'range': [None, 100]},
                    'bar': {'color': "#0f62fe"},
                    'steps': [
                        {'range': [0, 30], 'color': "#da1e28"},
                        {'range': [30, 60], 'color': "#f1c21b"},
                        {'range': [60, 100], 'color': "#24a148"}
                    ],
                    'threshold': {
                        'line': {'color': "black", 'width': 4},
                        'thickness': 0.75,
                        'value': 70
                    }
                }
            ))
            
            st.plotly_chart(fig, use_container_width=True)
            
            # AI Recommendation
            st.markdown("### ü§ñ Agent Recommendation")
            
            if readiness_score > 0.6:
                st.markdown(f"""
                <div class="success-box">
                <strong>HIGH PRIORITY MARKET</strong><br>
                {selected_country} shows strong fundamentals for infrastructure investment:
                - Well-established electricity infrastructure ({country_data.get('elec_pct', 0):.1f}% access)
                - Growing digital adoption ({country_data.get('internet_pct', 0):.1f}% internet users)
                - Sufficient economic capacity (${country_data.get('gdp_ppp', 0):,.0f} GDP/capita)
                
                <strong>Recommendation:</strong> Proceed with detailed site analysis and ROI modeling.
                </div>
                """, unsafe_allow_html=True)
            elif readiness_score > 0.3:
                st.markdown(f"""
                <div class="warning-box">
                <strong>MODERATE POTENTIAL MARKET</strong><br>
                {selected_country} presents mixed opportunities:
                - Electricity access at {country_data.get('elec_pct', 0):.1f}%
                - Internet adoption at {country_data.get('internet_pct', 0):.1f}%
                
                <strong>Recommendation:</strong> Focus on high-density areas first. Consider hybrid power solutions.
                </div>
                """, unsafe_allow_html=True)
            else:
                st.markdown(f"""
                <div class="warning-box">
                <strong>EMERGING MARKET - HIGH RISK</strong><br>
                {selected_country} requires significant infrastructure development:
                - Limited electricity infrastructure ({country_data.get('elec_pct', 0):.1f}% access)
                - Low digital penetration ({country_data.get('internet_pct', 0):.1f}% internet users)
                
                <strong>Recommendation:</strong> Evaluate rural deployment strategies with off-grid power. 
                Consider partnerships with development finance institutions.
                </div>
                """, unsafe_allow_html=True)

# ============================================================
# ANALYSIS 2: REGIONAL COMPARISON
# ============================================================

elif analysis_type == "üìä Regional Comparison":
    st.header("SADC Regional Comparison")
    
    with st.spinner("ü§ñ Agents analyzing all SADC countries..."):
        readiness_data = calculate_readiness_index()
        
        if readiness_data['countries_analyzed'] > 0:
            df = pd.DataFrame(readiness_data['rankings'])
            
            # Bar chart comparison
            fig = px.bar(
                df.sort_values('readiness_index', ascending=False),
                x='country',
                y='readiness_index',
                title="Infrastructure Readiness Index by Country",
                labels={'readiness_index': 'Readiness Score', 'country': 'Country'},
                color='readiness_index',
                color_continuous_scale='RdYlGn'
            )
            
            st.plotly_chart(fig, use_container_width=True)
            
            # Scatter plot: Internet vs Electricity
            fig2 = px.scatter(
                df,
                x='elec_pct',
                y='internet_pct',
                size='gdp_ppp',
                color='readiness_index',
                hover_name='country',
                title="Internet Adoption vs Electricity Access",
                labels={
                    'elec_pct': 'Electricity Access (%)',
                    'internet_pct': 'Internet Adoption (%)',
                    'gdp_ppp': 'GDP per Capita'
                },
                color_continuous_scale='Viridis'
            )
            
            st.plotly_chart(fig2, use_container_width=True)
            
            # Top 5 and Bottom 5
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("### üèÜ Top 5 Markets")
                top5 = df.nlargest(5, 'readiness_index')[['country', 'readiness_index', 'internet_pct', 'elec_pct']]
                st.dataframe(top5, hide_index=True)
            
            with col2:
                st.markdown("### üéØ Emerging Opportunities")
                bottom5 = df.nsmallest(5, 'readiness_index')[['country', 'readiness_index', 'internet_pct', 'elec_pct']]
                st.dataframe(bottom5, hide_index=True)

# ============================================================
# ANALYSIS 3: COVERAGE GAP ANALYSIS
# ============================================================

elif analysis_type == "üó∫Ô∏è Coverage Gap Analysis":
    st.header(f"Coverage Gap Analysis: {selected_country}")
    
    max_distance = st.slider("Maximum acceptable distance to tower (km)", 5, 30, 10)
    
    if st.button("üîç Analyze Coverage Gaps", type="primary"):
        with st.spinner("ü§ñ Coverage Gap Analyst Agent working..."):
            gap_data = find_coverage_gaps(selected_country, max_distance)
            
            if 'error' in gap_data:
                st.error(gap_data['error'])
            else:
                # Summary metrics
                col1, col2, col3, col4 = st.columns(4)
                
                with col1:
                    st.metric("Total Settlements", gap_data['total_settlements'])
                
                with col2:
                    st.metric("Existing Towers", gap_data.get('total_towers', 0))
                
                with col3:
                    st.metric(
                        "Underserved Settlements",
                        gap_data['underserved_settlements'],
                        delta=f"-{gap_data['coverage_percentage']:.1f}% coverage"
                    )
                
                with col4:
                    coverage = gap_data['coverage_percentage']
                    st.metric(
                        "Coverage Rate",
                        f"{coverage:.1f}%",
                        delta="Good" if coverage > 80 else "Needs Improvement"
                    )
                
                # Map visualization
                if gap_data['gaps']:
                    st.markdown("### üó∫Ô∏è Geographic Distribution of Gaps")
                    
                    gaps_df = pd.DataFrame(gap_data['gaps'][:100])  # Limit for performance
                    
                    fig = px.scatter_mapbox(
                        gaps_df,
                        lat='lat',
                        lon='lon',
                        hover_name='settlement',
                        hover_data=['distance_to_nearest_tower_km'],
                        zoom=5,
                        height=500,
                        title=f"Underserved Settlements in {selected_country}",
                        color='distance_to_nearest_tower_km',
                        color_continuous_scale='Reds'
                    )
                    
                    fig.update_layout(mapbox_style="open-street-map")
                    st.plotly_chart(fig, use_container_width=True)
                    
                    # Top priority settlements
                    st.markdown("### üéØ Priority Deployment Locations")
                    priority = gaps_df.nlargest(10, 'distance_to_nearest_tower_km')
                    st.dataframe(priority, hide_index=True)

# ============================================================
# ANALYSIS 4: COST ESTIMATION
# ============================================================

elif analysis_type == "üí∞ Cost Estimation":
    st.header(f"Deployment Cost Estimation: {selected_country}")
    
    st.markdown("### Configuration")
    
    col1, col2 = st.columns(2)
    
    with col1:
        num_towers = st.number_input("Number of towers to deploy", min_value=1, max_value=500, value=10)
        include_backhaul = st.checkbox("Include backhaul infrastructure", value=True)
    
    with col2:
        include_power = st.checkbox("Include power infrastructure", value=True)
    
    if st.button("üíµ Calculate Costs", type="primary"):
        with st.spinner("ü§ñ Calculating deployment costs..."):
            cost_data = estimate_deployment_cost(
                num_towers,
                selected_country,
                include_backhaul,
                include_power
            )
            
            # Display total cost prominently
            st.markdown("### üí∞ Total Investment Required")
            total = cost_data['cost_breakdown_usd']['total']
            st.markdown(f"<h1 style='color: #0f62fe;'>${total:,}</h1>", unsafe_allow_html=True)
            
            # Cost breakdown
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.metric(
                    "Towers & Equipment",
                    f"${cost_data['cost_breakdown_usd']['towers_and_equipment']:,}"
                )
            
            with col2:
                if include_backhaul:
                    st.metric(
                        "Backhaul",
                        f"${cost_data['cost_breakdown_usd']['backhaul']:,}"
                    )
            
            with col3:
                if include_power:
                    st.metric(
                        "Power Infrastructure",
                        f"${cost_data['cost_breakdown_usd']['power_infrastructure']:,}"
                    )
            
            # Pie chart
            breakdown = cost_data['cost_breakdown_usd']
            fig = go.Figure(data=[go.Pie(
                labels=['Towers', 'Backhaul', 'Power'],
                values=[
                    breakdown['towers_and_equipment'],
                    breakdown['backhaul'],
                    breakdown['power_infrastructure']
                ],
                hole=0.3
            )])
            
            fig.update_layout(title="Cost Distribution")
            st.plotly_chart(fig, use_container_width=True)
            
            # Per-tower cost
            st.info(f"**Cost per tower:** ${cost_data['cost_per_tower_usd']:,}")
            
            # Assumptions
            with st.expander("üìã Cost Assumptions"):
                for assumption in cost_data['assumptions']:
                    st.markdown(f"- {assumption}")

# ============================================================
# FOOTER
# ============================================================

st.markdown("---")
st.markdown("""
<div style='text-align: center; color: #525252;'>
<p><strong>Infrastructure Investment Intelligence</strong> | Powered by IBM watsonx Orchestrate</p>
<p>Built for IBM watsonx Orchestrate Agentic AI Hackathon 2025</p>
</div>
""", unsafe_allow_html=True)
